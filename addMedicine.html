<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add-Medicine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="styleSheet.css">
</head>
<body>
    <header class="navbar fixed-top">
        <div class="logo">
            <a class="navbar-brand" href="#">
                <img src="images/DoseCare_logo.png" alt="DoseCare" height="50">
            </a>
        </div>
        <div class="right">
            <button id="dark-mode-btn" class="dark-mode-toggle" title="Toggle Dark Mode">
                <img id="theme-icon" src="https://img.icons8.com/ios/50/2563eb/moon-symbol.png" alt="dark mode">
            </button>
            <button class="emergency-btn" onclick="triggerSOS()">SOS</button>
            <div class="user-container">
                <div class="user">TK</div>
                <div class="dropdown-content">
                    <a onclick="location.href='index.html'">Logout</a>
                </div>
            </div>
        </div> 
    </header> 

    <button class="back-link ">
    <span class="arrow" onclick='location.href="dashboard.html"'>‚ÜêBack to Dashboard</span>
    </button> 

    <div class="form-container">
    <div class="card">
        <h2>Add New Medication</h2>
        <p class="subtitle">Enter the details below or scan the barcode to track your new prescription.</p>
         <hr>
        
        <!-- Scanner Section -->
        <div class="scanner-section mb-4">
            <div id="reader" style="width: 100%; border-radius: 10px; overflow: hidden; display: none;"></div>
            <button id="scan-btn" class="btn2-con" style="width: 100%; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://img.icons8.com/windows/32/228BE6/qr-code.png" alt="" height="24" width="24">
                Scan Medicine Barcode
            </button>
        </div>

        <form id="med-form">
            <div class="d-flex align-items-center justify-content-between">
                <label style="margin-top: 0;">Medicine Name</label>
                <button type="button" id="info-btn" class="btn" style="padding: 0; color: #2563eb;" data-bs-toggle="modal" data-bs-target="#medInfoModal">
                    <img src="https://img.icons8.com/ios/50/2563eb/info--v1.png" alt="info" width="24" height="24">
                </button>
            </div>
            <input type="text" id="medicine-name" placeholder="e.g. Paracetamol" required>
            <div class="row">
                <div>
                    <label>Dosage Strength</label>
                    <input type="text" id="dosage-strength" placeholder="e.g. 10mg">
                </div>
                <div>
                    <label>Frequency</label>
                    <select id="frequency">
                        <option>Once Daily</option>
                        <option>Twice Daily</option>
                        <option>Thrice Daily</option>
                        <option>Every 4 hours</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div>
                    <label>Time of Day</label>
                    <input type="time" id="med-time" value="08:00">
                </div>

                <div>
                    <label>Current Stock (Pills/Units)</label>
                    <input type="number" id="stock" value="30">
                </div>
            </div>
            <label>Refill Alert Level</label>
            <input type="number" id="refill-level" value="5">
            <label>Special Instructions (Optional)</label>
            <textarea id="instructions" placeholder="e.g. Take with food, Do not crush"></textarea>
            <button type="submit" class="add-btn">+ Add Medicine</button>
        </form>
    </div>
</div>

<!-- Medicine Info Modal -->
<div class="modal fade" id="medInfoModal" tabindex="-1" aria-labelledby="medInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 20px; border: none;">
      <div class="modal-header" style="border-bottom: 1px solid #f1f5f9;">
        <h5 class="modal-title" id="medInfoModalLabel" style="font-weight: 700; color: #0f172a;">Medicine Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body-content" style="font-size: 16px; color: #475569; line-height: 1.6;">
        <!-- Content will be injected by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
    // Request notification permission
    if ("Notification" in window) {
        Notification.requestPermission();
    }

    const medForm = document.getElementById('med-form');
    const scanBtn = document.getElementById('scan-btn');
    const readerDiv = document.getElementById('reader');
    const medicineInput = document.getElementById('medicine-name');
    const dosageInput = document.getElementById('dosage-strength');
    const infoBtn = document.getElementById('info-btn');
    const modalBody = document.getElementById('modal-body-content');
    const modalTitle = document.getElementById('medInfoModalLabel');
    let html5QrCode;

    medForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const newMed = {
            id: Date.now(),
            name: document.getElementById('medicine-name').value,
            dosage: document.getElementById('dosage-strength').value,
            frequency: document.getElementById('frequency').value,
            time: document.getElementById('med-time').value,
            stock: document.getElementById('stock').value,
            instructions: document.getElementById('instructions').value,
            lastNotified: null
        };

        const existingMeds = JSON.parse(localStorage.getItem('dosecare_meds') || '[]');
        existingMeds.push(newMed);
        localStorage.setItem('dosecare_meds', JSON.stringify(existingMeds));
        
        alert(`Medicine "${newMed.name}" added and reminder set for ${newMed.time}!`);
        location.href = 'dashboard.html';
    });

    // Expanded Mock Database
    const mockMedDB = {
        "12345678": { 
            name: "Paracetamol", 
            dosage: "500mg",
            usage: "Used to treat mild to moderate pain (such as headache, toothache, or backache) and to reduce fever.",
            effects: "Reduces pain and fever within 30-60 minutes.",
            sideEffects: "Rarely causes side effects, but may include skin rash or swelling if allergic.",
            missedDose: "Take it as soon as you remember. If it is almost time for your next dose, skip the missed dose. Do not double the dose.",
            timing: "Can be taken before or after dinner. Avoid taking on an empty stomach if you have a sensitive stomach.",
            other: "Do not exceed 4000mg in 24 hours to avoid liver damage."
        },
        "87654321": { 
            name: "Ibuprofen", 
            dosage: "200mg",
            usage: "Used for relieving pain from various conditions such as headache, dental pain, menstrual cramps, muscle aches, or arthritis.",
            effects: "Reduces inflammation and pain by blocking hormones that cause inflammation.",
            sideEffects: "Upset stomach, nausea, vomiting, headache, diarrhea, or dizziness.",
            missedDose: "Take it as soon as you remember. If it is near the time of the next dose, skip the missed dose.",
            timing: "Best taken after dinner or with milk to prevent stomach upset.",
            other: "Avoid if you have a history of stomach ulcers."
        },
        "44332211": { 
            name: "Lisinopril", 
            dosage: "10mg",
            usage: "Used to treat high blood pressure (hypertension) and heart failure.",
            effects: "Relaxes blood vessels so blood can flow more easily.",
            sideEffects: "Dizziness, headache, fatigue, or a persistent dry cough.",
            missedDose: "Take the missed dose as soon as you remember. Skip if it's nearly time for the next one.",
            timing: "Can be taken before or after dinner, but should be taken at the same time each day.",
            other: "Check your blood pressure regularly while on this medication."
        }
    };

    function updateMedInfo(input) {
        const medData = mockMedDB[input] || Object.values(mockMedDB).find(m => m.name.toLowerCase() === input.toLowerCase());
        
        if (medData) {
            medicineInput.value = medData.name;
            dosageInput.value = medData.dosage;
            modalTitle.textContent = medData.name + " Information";
            modalBody.innerHTML = `
                <div class="mb-3"><strong><img src="https://img.icons8.com/color/48/pill.png" width="20"> Usage:</strong><br>${medData.usage}</div>
                <div class="mb-3"><strong><img src="https://img.icons8.com/color/48/heart-monitor.png" width="20"> Effects:</strong><br>${medData.effects}</div>
                <div class="mb-3"><strong><img src="https://img.icons8.com/color/48/error.png" width="20"> Side Effects:</strong><br>${medData.sideEffects}</div>
                <div class="mb-3"><strong><img src="https://img.icons8.com/color/48/alarm-clock.png" width="20"> Missed Dose:</strong><br>${medData.missedDose}</div>
                <div class="mb-3"><strong><img src="https://img.icons8.com/color/48/restaurant.png" width="20"> Timing:</strong><br>${medData.timing}</div>
                <div class="mb-0"><strong><img src="https://img.icons8.com/color/48/info.png" width="20"> Important Note:</strong><br>${medData.other}</div>
            `;
        } else {
            modalTitle.textContent = "Medicine Not Found";
            modalBody.innerHTML = `
                <div class="text-center p-4">
                    <img src="https://img.icons8.com/ios/100/64748b/search--v1.png" width="60" class="mb-3">
                    <p>No detailed information found for "<b>${input || 'this medicine'}</b>".</p>
                    <p class="text-muted small">Try entering "Paracetamol", "Ibuprofen", or "Lisinopril" to see a demonstration of this feature.</p>
                </div>
            `;
        }
    }

    infoBtn.addEventListener('click', () => {
        updateMedInfo(medicineInput.value);
    });

    scanBtn.addEventListener('click', () => {
        if (readerDiv.style.display === 'none') {
            readerDiv.style.display = 'block';
            scanBtn.textContent = 'Stop Scanning';
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };

            html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                (decodedText, decodedResult) => {
                    updateMedInfo(decodedText);
                    stopScanning();
                },
                (errorMessage) => { }
            ).catch((err) => {
                console.error(err);
                stopScanning();
            });
        } else {
            stopScanning();
        }
    });

    function stopScanning() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                readerDiv.style.display = 'none';
                scanBtn.innerHTML = `<img src="https://img.icons8.com/windows/32/228BE6/qr-code.png" alt="" height="24" width="24"> Scan Medicine Barcode`;
            }).catch((err) => console.error(err));
        } else {
            readerDiv.style.display = 'none';
            scanBtn.innerHTML = `<img src="https://img.icons8.com/windows/32/228BE6/qr-code.png" alt="" height="24" width="24"> Scan Medicine Barcode`;
        }
    }

    // Dynamic User Initials
    document.addEventListener('DOMContentLoaded', () => {
        // Dark Mode
        const darkModeBtn = document.getElementById('dark-mode-btn');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;

        const setDarkMode = (isDark) => {
            if (isDark) {
                body.classList.add('dark-mode');
                themeIcon.src = 'https://img.icons8.com/ios/50/FFD700/sun--v1.png';
                localStorage.setItem('dosecare_theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                themeIcon.src = 'https://img.icons8.com/ios/50/2563eb/moon-symbol.png';
                localStorage.setItem('dosecare_theme', 'light');
            }
        };

        darkModeBtn.addEventListener('click', () => {
            setDarkMode(!body.classList.contains('dark-mode'));
        });

        if (localStorage.getItem('dosecare_theme') === 'dark') {
            setDarkMode(true);
        }

        const userName = localStorage.getItem('dosecare_user_name') || 'Tanishka';
        const userIcon = document.querySelector('.user');
        if (userIcon) {
            const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            userIcon.textContent = initials;
        }
    });

    function triggerSOS() {
        const contacts = JSON.parse(localStorage.getItem('dosecare_emergency_contacts'));
        if (contacts) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const mapLink = `https://www.google.com/maps?q=${lat},${lng}`;
                    const message = `EMERGENCY! I need help. My location: ${mapLink}`;
                    
                    alert(`üö® SOS ALERT!\n\nLocation: Found\n\n1. Calling ${contacts.c1.name}...\n2. Location SMS will follow.`);
                    window.location.href = `tel:${contacts.c1.num}`;
                    
                    setTimeout(() => {
                        if(confirm("Send GPS location link to contacts?")) {
                            window.location.href = `sms:${contacts.c1.num};${contacts.c2.num}?body=${encodeURIComponent(message)}`;
                        }
                    }, 2000);
                }, () => {
                    window.location.href = `tel:${contacts.c1.num}`;
                });
            } else {
                window.location.href = `tel:${contacts.c1.num}`;
            }
        } else {
            alert("SOS Triggered! No emergency contacts found.");
        }
    }
</script>
</body>
</html>